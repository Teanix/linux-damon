#!/bin/bash

debugfs_dir=$(mount | grep -e "type debugfs" | awk '{print $3}')
if [ -z "$debugfs_dir" ]
then
	>&2 echo "debugfs not found"
	exit 1
fi

damon_dir="$debugfs_dir/damon"
if [ ! -d "$damon_dir" ]
then
	>&2 echo "damon dir not found"
	exit 1
fi

pr_usage()
{
	>&2 echo "Usage: $0 [OPTION]... <command>"
	>&2 echo
	>&2 echo "OPTION"
	>&2 echo "  --sampling <interval>	Sampling interval (us)"
	>&2 echo "  --aggregate <interval>	Aggregate interval (us)"
	>&2 echo "  --update <interval>	Regions update interval (us)"
	>&2 echo "  --min-reg <nr>		Minimum number of regions"
	>&2 echo "  --max-reg <nr>		Maximum number of regions"
}

if [ $# -lt 2 ]
then
	pr_usage
	exit 1
fi

# 5ms, 100ms, 1s
sampling_interval=5000
aggregate_interval=100000
regions_update_interval=1000000
min_nr_regions=10
max_nr_regions=1000
cmd=""

perf_opts=""
while [ $# -ne 0 ]
do
	case $1 in
	"-")
		perf_opts="$perf_opts $1"
		shift 1
		break
		;;
	*)
		perf_opts="$perf_opts $1"
		shift 1
		continue
		;;
	esac
done

if [ "$perf_opts" = " -" ]
then
	perf_opts=""
fi

while [ $# -ne 0 ]
do
	case $1 in
	"--sampling")
		if [ $# -lt 2 ]
		then
			>&2 echo "<interval> not given"
			pr_usage
			exit 1
		fi
		sampling_interval=$2
		shift 2
		continue
		;;
	"--aggregate")
		if [ $# -lt 2 ]
		then
			>&2 echo "<interval> not given"
			pr_usage
			exit 1
		fi
		aggregate_interval=$2
		shift 2
		continue
		;;
	"--update")
		if [ $# -lt 2 ]
		then
			>&2 echo "<interval> not given"
			pr_usage
			exit 1
		fi
		regions_update_interval=$2
		shift 2
		continue
		;;
	"--min_reg")
		if [ $# -lt 2 ]
		then
			>&2 echo "<nr> not given"
			pr_usage
			exit 1
		fi
		min_nr_regions=$2
		shift 2
		continue
		;;
	"--max_reg")
		if [ $# -lt 2 ]
		then
			>&2 echo "<nr> not given"
			pr_usage
			exit 1
		fi
		max_nr_regions=$2
		shift 2
		continue
		;;
	*)
		if [ $# -lt 1 ]
		then
			>&2 echo "<command> not given"
			pr_usage
			exit 1
		fi
		cmd="$*"
		break
		;;
	esac
done

if [ -z "$cmd" ]
then
	pr_usage
	exit 1
fi

attrs="$sampling_interval $aggregate_interval $regions_update_interval"
attrs="$attrs $min_nr_regions $max_nr_regions"

echo "$attrs" > "$damon_dir/attrs"

$cmd &
cmd_pid=$!

echo "$cmd_pid" > "$damon_dir/target_ids"
echo "on" > "$damon_dir/monitor_on"

perf record -e damon:damon_aggregated $perf_opts &
perf_pid=$!

sigint_trap()
{
	kill 2 "$cmd_pid"
	kill 2 "$perf_pid"
	exit
}

trap sigint_trap INT

>&2 echo "Press Control+C to stop recording"

while :;
do
	on_off=$(cat "$damon_dir/monitor_on")
	if [ "$on_off" = "off" ]
	then
		kill 2 $perf_pid
		break
	fi
	sleep 1
done
